schemaVersion: 2.2.2
metadata:
  name: cobol-devspace
  displayName: IBM COBOL
  description: IBM COBOL development space
  tags:
    - cobol
    - class
  projectType: COBOL
  language: IBM COBOL
  version: 1.0.0
variables:
  gitConfigScript: |-
    #!/bin/bash
    export GIT_PAT=$(cat /.git-credentials/credentials | awk -F "[:@]" '{print $3}')
    export GIT_EMAIL=$(curl -s -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GIT_PAT" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/user/emails | jq -r ".[0].email")
    export GIT_USER=$(curl -s -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GIT_PAT" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/user | jq -r ".name")
    echo "Setting git user.name=$GIT_USER"
    git config --global user.name "$GIT_USER"
    echo "Setting git user.email=$GIT_EMAIL"
    git config --global user.email "$GIT_EMAIL"
components:
  - name: cobol-workspace
    container:
      image: registry.redhat.io/devspaces/udi-rhel8@sha256:bc5d28c434089a312ab0944662e7702481ca4e898ef278cf61c0f683f35718df
commands:
  - id: update-extensions
    exec:
      component: cobol-workspace
      commandLine: 'code-oss --update-extensions'
  - id: git-config
    exec:
      component: cobol-workspace
      commandLine: 'echo "{{gitConfigScript}}" >> ~/git-config.sh && chmod +x ~/git-config.sh && ~/git-config.sh'
events:
  postStart:
    - git-config
